Dưới đây là **Tài liệu Đặc tả Kỹ thuật (SRS/PRD) – Entry/SL/TP của ICT/SMC & Momentum cho EA MT5** đã chuẩn-hoá để DEV có thể code **đúng logic** ngay. Em tuân thủ các ràng buộc của anh:

* **Entry** có 2 chế độ: **SMC pullback** & **Momentum breakout** (có thể bật đồng thời). **Ưu tiên Momentum** khi conflict.
* **TP/SL**: "theo phương pháp nào thì TP/SL theo phương pháp đó"; **cho phép override theo pip/points** (nhiều loại có thể chọn).
* **DCA** theo **%Balance** + **Multiplier**, có **MaxLotPerSide ĐỘNG** (base 1 lot, +0.1/1k$ balance tăng).
* **Đo bằng POINTS** để tránh nhầm lẫn (XAUUSD mặc định **1 pip = 10 points**, **1 giá = 100 points**).
* **MinStop mặc định 30 pip = 300 points**.
* **Bỏ SpreadMax filter** (nhưng có guard slippage/retry).
* **Bỏ Liquidity Sweep bắt buộc** - không require sweep trước BOS.
* **FVG quét động** - giá tới đâu quét tới đó, loại bỏ đã hoàn thành.
* **Trailing SL bắt buộc** cho Momentum (ATR trail sau 1R).
* **Timezone**: Asia/Ho_Chi_Minh (ICT+7).
* **BOX visualization**: vẽ và update real-time khi thay đổi.

## ✅ **USER CONFIRMATIONS (2025-10-08)**

1. ✅ Kết hợp cả 2 phần tài liệu (phương pháp ICT/SMC + Lifecycle management)
2. ✅ FVG quét động theo giá, loại bỏ đã hoàn thành
3. ✅ Cho phép nhiều lệnh từ nhiều POI
4. ✅ Ưu tiên Momentum, bắt buộc trailing SL
5. ✅ MaxLotPerSide động: 1 lot base + 0.1/1k$ balance
6. ✅ TP/SL chia nhiều loại có thể chọn
7. ✅ Timezone: Asia/Ho_Chi_Minh (ICT+7)
8. ✅ BOX vẽ chart và update real-time
10. ✅ Bỏ Liquidity Sweep requirement

## 🔄 **UPDATE V4.1 (2025-10-08) - FIX "0 ENTRY" & OPTIMIZATION**

> **Based on**: `@update-config.md` - Chuẩn hóa đơn vị + Fix lifecycle để có entry

### **1. Unit Converter System (CHUẨN HÓA ĐƠN VỊ)**

**Quy ước cố định:**
```
1 GIÁ = 10 PIP = 1,000 POINTS
```

**Implementation:**
- ✅ `InpPointsPerPip = 100` (CHUẨN mới, thay vì 10)
- ✅ Enum `UNIT_POINTS | UNIT_PIPS | UNIT_GIA`
- ✅ Functions: `PointsFromInput()`, `PriceDeltaToPoints()`, `PointsToPips()`, `PointsToGia()`
- ✅ **TẤT CẢ distance** đều normalize về **POINTS** trước khi so sánh

**Lý do:** Tránh nhầm lẫn giữa pip/giá/points → logic sai → no entry.

---

### **2. Session Filter - Fixed Timezone Conversion**

**Vấn đề:** So sánh server time trực tiếp với ICT time (GMT+7) → lệch múi giờ.

**Fix:**
- ✅ Thêm `InpBrokerGMTOffset` (auto-detect hoặc manual)
- ✅ Function `ServerTimeToICT()` convert đúng cách
- ✅ Function `GetBrokerGMTOffset()` tự động detect hoặc dùng input

**Logic:**
```
ICT_time = Server_time + (7 - BrokerOffset) hours
```

---

### **3. FVG Lifecycle - Nới Điều Kiện Entry**

**Changes:**
- ✅ Cho phép entry **CẢ ACTIVE và PARTIAL** (trước chỉ ACTIVE)
- ✅ `InpFVG_Fill_MinPct = 25%` (giảm từ 50% → cửa sổ rộng hơn)
- ✅ `InpFVG_MitigatePct = 65%` (tăng từ 50% → chuyển PARTIAL sớm hơn)
- ✅ `InpFVG_CompletionPct = 85%` (giảm từ 95%)
- ✅ `InpFVG_MinSizePts = 300` (0.3 giá - giữ nguyên)

**Code location:** `DetectSMCPullback()` - Check status

**Lý do:** FVG PARTIAL vẫn hợp lệ cho entry, không nên loại ra.

---

### **4. OB Touch Logic - Fixed "Già" Quá Nhanh**

**Vấn đề:** `touch_count++` mỗi bar close trong OB → hết tuổi thọ nhanh.

**Fix:**
- ✅ Chỉ tăng `touch_count` khi **CROSS-IN** (từ ngoài vào trong)
- ✅ Logic: `prev_close` ngoài range && `curr_close` trong range → touch++
- ✅ `InpOB_MaxTouches = 20` (tăng từ 2 → nhiều cơ hội hơn)
- ✅ `InpOB_TTL_Bars = 240` (tăng từ 200)

**Code location:** `UpdateOBStatus()` - Touch count logic

---

### **5. Momentum Freshness - Flexible**

**Changes:**
- ✅ Dùng `InpMOMO_Fail_Bars` thay hardcode `< 5`
- ✅ Default `InpMOMO_Fail_Bars = 4` (giảm từ 5)
- ✅ `InpMinDispATR_Momo = 0.9` (giảm từ 1.2 → dễ trigger hơn)

**Code location:** `DetectMomentumBreakout()` - Duplicate check

---

### **6. Enhanced Dashboard - Detailed Structures**

**New Features:**
- ✅ Show chi tiết **từng FVG/OB/Momentum** đang wait
- ✅ **[✓] Tick xanh** nếu structure VALID cho entry
- ✅ **[X]** nếu expired/không hợp lệ
- ✅ Hiển thị: ID, price range, fill%, pullback%, age, ATR multiple

**Example Output:**
```
║ WAITING STRUCTURES (Detailed):           ║
║ [✓] FVG_L #12: 2548.5-2550.2 fill 35% ACT║
║ [✓] FVG_S #18: 2552.0-2554.5 fill 10% ACT║
║ [✓] OB_L #8: 2546.0-2548.0 pb 45% T:1/20 ║
║ [X] MOMO_L #3: age 5 bars ATR 1.2x       ║
```

---

### **7. Updated Default Parameters**

| Parameter | Old | New | Reason |
|-----------|-----|-----|--------|
| `InpPointsPerPip` | 10 | **100** | Chuẩn hóa đơn vị |
| `InpFVG_Fill_MinPct` | 50% | **25%** | Cửa sổ entry rộng hơn |
| `InpFVG_MitigatePct` | 50% | **65%** | Chuyển PARTIAL sớm |
| `InpFVG_CompletionPct` | 95% | **85%** | Hoàn thành sớm hơn |
| `InpOB_MaxTouches` | 2 | **20** | Cross-in only |
| `InpOB_TTL_Bars` | 200 | **240** | Tuổi thọ dài hơn |
| `InpMOMO_Fail_Bars` | (hardcode 5) | **4** | Flexible parameter |
| `InpMinDispATR_Momo` | 1.2 | **0.9** | Dễ trigger |

---

### **8. Testing Checklist**

- [ ] Backtest 2 tuần M5 XAUUSD → có entry
- [ ] Session ON/OFF → entry đúng giờ
- [ ] FVG PARTIAL → có entry
- [ ] OB touch count → chỉ tăng khi cross-in
- [ ] Momentum age → dùng InpMOMO_Fail_Bars
- [ ] Dashboard → show structures chi tiết
- [ ] Unit converter → tất cả distances đúng

---

# 1) Decompose → Plan → ToT (scored) → Reverse Thinking

## 1.1 Decompose

* **Market Filters**: Timezone Asia/Ho_Chi_Minh, session (ICT Killzone tuỳ chọn, mặc định OFF), News OFF (theo yêu cầu), Slippage guard ON, MinStop clamp ON.
* **Entry**:

  * **SMC Pullback**: yêu cầu **BOS (đóng cửa)** + **displacement**; vùng **OB**/**FVG** hợp lệ; Entry khi **pullback đến OB ≥ X%** hoặc **fill FVG ≥ Y%** (có thể thêm **liquidity sweep** trước đó – optional).
  * **Momentum Breakout**: nến **đóng cửa** phá **SwingH/L** với biên độ **≥ ATR*k** (displacement).
* **SL/TP**:

  * **Derive from Method** (mặc định): SMC dùng **StructureStop + buffer**, Momentum dùng **SwingStop + buffer**, TP theo **Structure** hoặc **R-multiple** phù hợp phương pháp.
  * **Override FixedDistance** (tuỳ chọn): nhập **SL/TP theo pip/points**, auto quy đổi về **points**.
* **DCA Engine**: %Balance per add, **LotMultiplier**, **StepPoints**, **MinDistFromAvg**, **MaxOrders**, **MaxLotPerSide (Cap HARD/SOFT)**.
* **Basket Manager**: TP/SL theo **%Balance** (tuỳ chọn), Daily loss limit, Timeout, Breach kill-switch.
* **Order/Exec**: magic isolation, one trade per bar, retry on reject, slippage guard, rounding lots theo `SYMBOL_VOLUME_STEP`.

## 1.2 Plan (chuỗi xử lý)

1. **Collect context** (symbol digits/Point, session, ATR, swings, spread, slippage, positions hiện tại).
2. **Sinh signal**: SMC + Momentum.
3. **Resolve**: nếu cùng chiều → hợp nhất; nếu ngược chiều → theo `ConflictPolicy` (mặc định **NoTrade**).
4. **Chọn phương pháp kích hoạt** (SMC hoặc Momentum) → **tính SL/TP** theo **Derive** hoặc **Override**.
5. **Tính lot** theo %Risk và **Enforce MaxLotPerSide** (Cap HARD/SOFT).
6. **Đặt lệnh #1** (attach TP/SL).
7. **Vòng DCA**: theo StepPoints/MinDistFromAvg/Multiplier, vẫn **enforce cap**.
8. **Quản trị basket**: partial, trailing, basket TP/SL theo %Balance, timeout/kill-switch.
9. **Journal** (log chuẩn để debug & backtest).

## 1.3 ToT (2–3 phương án) – Chấm điểm

* **A) SMC-only + DCA nhẹ** (Correctness 9 | Risk 5 | Cost/Time 6): ổn khi thị trường mean-revert theo cấu trúc.
* **B) Momentum-only + DCA nhẹ** (8 | 7 | 5): tốt khi trend rõ; dễ whipsaw nếu ATR thấp.
* **C) Hybrid SMC+Momentum, `ConflictPolicy=NoTrade`** (**Recommended**) (9 | 6 | 7): chọn setup “chắc tay” mỗi thời điểm, giảm xung đột.

## 1.4 Reverse Thinking (contrarian)

* **Bỏ Spread filter** + tin tức/rollover ⇒ **slippage spike**: bắt buộc `SlippageMax` + `RetryOnReject` + **NoTrade trong vài phút quanh rollover/news lớn** (cờ optional).
* **DCA**: multiplier lớn hoặc Step quá nhỏ ⇒ **DD phình**; giữ Multiplier **1.05–1.15**, Step **≥ 1500–2500 points**, **MaxOrders ≤ 6–7**.
* **MinStop clamp 300 points**: nếu cấu trúc gợi ý SL < 300 ⇒ **clamp** tránh **stop quá sát**.

---

# 2) Glossary (định nghĩa có thể code)

| Term                         | Định nghĩa lập trình (codeable)                                                                                                                               |            |                                |
| ---------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------- | ------------------------------ |
| **SwingH/L**                 | **Fractal depth k** (mặc định `k=2`): SwingH là đỉnh mà **High[i] > High[i-1..i-k] và High[i] ≥ High[i+1..i+k]**. SwingL tương tự cho Low.                    |            |                                |
| **BOS (Break of Structure)** | Nến **Close** vượt qua **SwingH/L gần nhất** theo hướng đang xét **+ buffer (0 points)**, kèm **displacement**: `TrueRange(EntryBar) ≥ ATR(14) * MinDispATR`. |            |                                |
| **Displacement**             | `TrueRange` hoặc `                                                                                                                                            | Close-Open | `của nến phá, so với`ATR(14)`. |
| **Order Block (OB)**         | Nến **ngược chiều** cuối cùng **trước** cú đẩy tạo BOS. Biên vùng = **High/Low** nến đó (tuỳ Buy/Sell). Tuỳ chọn **Refine body**: biên trong = Open/Close.    |            |                                |
| **FVG (3-candle)**           | Khoảng trống: **Low(candle2) > High(candle0)** (up) hoặc **High(candle2) < Low(candle0)** (down). `FVG_MinSizePts` mặc định **300 points**.                   |            |                                |
| **Liquidity Sweep/Grab**     | High/Low vừa **quét** qua một SwingH/L liền trước **rồi đóng quay đầu**, xác nhận bằng wick/close; optional filter.                                           |            |                                |
| **Killzone (ICT)**           | Khung giờ phiên Á/Âu/Mỹ (đổi sang ICT+7). Mặc định **OFF** để không hạn chế entry.                                                                            |            |                                |
| **Price/Pip/Point** (XAUUSD) | `_Point` thường = **0.01**. **1 pip = 10 points**, **1 giá = 100 points**. `PointsPerPip=10`.                                                                 |            |                                |

---

# 3) Logic Entry → SL/TP chi tiết

## 3.1 SMC Pullback

**Điều kiện hợp lệ**

1. **BOS (close)** qua SwingH/L gần nhất **+ displacement**:

   * `MinDispATR_SMC = 1.0` (range nến phá ≥ 1.0 × ATR(14)).
   * `BOS_FractalK = 2` (config).
2. **Vùng phản ứng** có ít nhất **1** trong 2:

   * **OB** hợp lệ (the last opposite candle before impulse).
   * **FVG** 3-candle có size ≥ `FVG_MinSizePts = 300`.
3. **Trigger** (thoả **1**):

   * Pullback vào **OB** đạt `OB_Pullback_MinPct = 25%` độ dày OB (từ mép ngoài vào).
   * **FVG fill** đạt `FVG_Fill_MinPct = 50%`.

**Entry**

* **Buy**: sau BOS-up, trigger tại **pullback** vào OB/FVG theo rule trên.
* **Sell**: ngược lại.

**Stop Loss (SMC)**

* **StructureStop**: đặt **ngoài mép vùng** (đáy OB đối với Buy / đỉnh OB đối với Sell) **+ SLBufferPts**.
* **Clamp**: `SL ≥ MinStopPointsClamp` (mặc định **300 points**).

**TP & Quản trị**

* **TP1**: **mid-FVG** (nếu có) **hoặc 1R** (khi bật R-multiple).
* **TP2**: **mép đối diện vùng** (OB/FVG) **hoặc 2R**.
* **Trailing**: **Structure-trail** theo HL/LH mới hình thành; `TrailStepMinPts = 300`.

> ~~**Optional (tăng xác suất)**: yêu cầu **Liquidity Sweep** xảy ra ngay trước BOS; nếu bật, chỉ cho phép entry khi có sweep.~~ → **BỎ** (confirmed - không bắt buộc Liquidity Sweep).

## 3.2 Momentum Breakout

**Điều kiện hợp lệ**

* Nến **đóng cửa** **trên SwingH** (Buy) / **dưới SwingL** (Sell), và
* **Displacement**: `TrueRange(BarBreakout) ≥ ATR(14) * MinDispATR_Momo`, với `MinDispATR_Momo = 1.2`.

**Entry**

* **Market** tại close nến phá (hoặc **Stop** tại SwingH/L ± buffer nếu muốn chống slip – optional).

**Stop Loss (Momentum)**

* **SwingStop** sau Swing bị phá **+ SLBufferPts**; **Clamp ≥ 300 points**.

**TP & Trailing**

* **R-multiple** mặc định: **TP1 = 1R** (partial 30–50%), **TP2 = 2R**.
* Khi đạt **1R**, bật **ATR-trail** (`ATR_Period=14`, `ATR_Mult=2.0`, `TrailStepMinPts=300`).

## 3.3 Conflict Handling (khi bật cả 2 phương pháp)

* **Cùng chiều**: hợp nhất, **ƯU TIÊN MOMENTUM** (confirmed by user). Momentum có trailing SL bắt buộc.
* **Ngược chiều**: theo `ConflictPolicy` (mặc định **NoTrade**). Tuỳ chọn `PreferTrend` (nhìn bias của ATR slope/HTF).
* **TRAILING SL**: Khi Momentum active, **BẮT BUỘC** phải kéo SL theo (ATR trail sau khi đạt 1R).

---

# 4) SL/TP theo pip/points (Override)

## 4.1 Cấu hình

* `DistanceUnit` = {`POINTS`,`PIPS`} (mặc định **POINTS**).
* `PointsPerPip` (XAUUSD mặc định **10**).
* `SLTP_DeriveFromMethod` (mặc định **true**).
* `SLTP_Override_Mode` = {`Structure`,`RMultiple`,`FixedDistance`} (kích hoạt khi `Derive=false`).
* `SL_FixedDist`, `TP_FixedDist` (đơn vị theo `DistanceUnit`).

## 4.2 Quy đổi & áp dụng

```text
if DistanceUnit == PIPS:
    dist_points = round(value * PointsPerPip)
else:
    dist_points = round(value)

Price calc (BUY):
SL = Entry - dist_points * _Point
TP = Entry + dist_points * _Point
(Sell ngược lại)
```

* **Derive=true**: theo **phương pháp Entry**.
* **Derive=false + FixedDistance**: ép SL/TP cố định (ví dụ SL=50 pip → 500 points, TP=100 pip → 1000 points) **cho mọi Entry**.
* Vẫn áp **Clamp MinStopPointsClamp** (≥ 300).

---

# 5) DCA Engine

## 5.1 Luật add lệnh

* **EnableDCA=true**, **MaxOrders=6** (bao gồm lệnh #1).
* **StepPoints=2000** (khoảng cách giữa Giá hiện tại đến **Average Entry** hoặc đến **lần add gần nhất** – chọn bằng `DCA_StepMode`).
* **MinDistFromAvg=1000**: không add nếu khoảng cách đến **Average** < 1000 points.
* **Confluence requirement (tuỳ chọn)**: chỉ add khi còn giữ **bias ban đầu** (không bị BOS ngược).

## 5.2 Sizing mỗi add

* **BaseRiskPct_PerAdd = 0.10%** Balance.
* Quy đổi **%risk → lots** dựa trên **StopPoints hiện hành** (tính từ **phương pháp đang chạy**).
* Áp **LotMultiplier** (mặc định **1.10**) theo số thứ tự add.
* **Enforce MaxLotPerSide** (xem 6.2).

---

# 6) Risk/Exec/Order Management

## 6.1 Guard chung

* **MinStopPointsClamp = 300** (30 pip).
* **SlippageMaxPoints = 120**; nếu >120 points: **RetryOnReject** (tối đa 2 lần với delay 200–500ms).
* **One trade per bar** (chống spam).
* **NoTrade windows** (optional): ±X phút quanh rollover (EOD) / major news (nếu sau bật NewsFilter).

## 6.1b Session Filter & Time Management (CONFIRMED)

* **EnableSessionFilter** (mặc định **OFF**): không hạn chế giờ trade.
* **3 Custom Sessions** có thể config:
  * Session 1: `08:00–11:30` (GMT+7) - Asian overlap
  * Session 2: `14:00–17:00` (GMT+7) - London open
  * Session 3: `19:00–23:30` (GMT+7) - NY session
* **Timezone**: Asia/Ho_Chi_Minh (GMT+7) - cố định.
* **Rollover Filter**: Chặn entry ±5 phút quanh `00:00` broker time (tránh spike spread/slippage).
* **Hành vi ngoài session**:
  * **KHÔNG** mở lệnh mới (entry).
  * **VẪN** quản lý lệnh đang có (trailing, DCA, basket TP/SL, timeout).
  * **KHÔNG** đóng lệnh cũ khi hết session.

## 6.2 MaxLotPerSide (config) - ĐỘNG THEO BALANCE

* `MaxLotPerSide_Base = 1.00` (mặc định khi balance = initial).
* **CÔNG THỨC ĐỘNG**: `MaxLotPerSide = Base + floor((Balance - InitialBalance) / 1000) * 0.1`
  * Ví dụ: Balance tăng 1000$ → +0.1 lot; tăng 2500$ → +0.2 lot.
* `CapMode = SOFT` (recommend) | `HARD`.
* `OnMaxLotExceededAction = ReduceToFit` | `BlockAdds` | `Flatten` (ít khuyến nghị).

**Hành vi**

* **SOFT/ReduceToFit**: cắt `LotsNew` để không vượt trần; nếu < `SYMBOL_VOLUME_MIN` thì **bỏ add**.
* **HARD/BlockAdds**: chặn mở thêm khi vượt trần.

## 6.3 Basket Manager (tuỳ chọn)

* **BasketTP_PctBalance** = 0.3% (đề xuất).
* **BasketSL_PctBalance** = 1.2% (đề xuất).
* **DailyLossLimit_PctBalance** (ví dụ 2–3%): khi chạm → **BREACH**: dừng giao dịch đến hết ngày theo timezone **ICT+7**.
* **TimeoutMins**: đóng toàn basket nếu quá lâu mà chưa đạt target (tránh “kẹt lệnh”).

## 6.4 Thực thi & Kỹ thuật khớp

* **MagicNumber** theo cặp/method để isolate.
* **Hedging mode**: nhiều vị thế cùng chiều được phép.
* **Ràng buộc broker**: `SYMBOL_VOLUME_MIN/STEP/MAX`, `SYMBOL_TRADE_TICK_SIZE`, `MODE_STOPLEVEL`.
* **Rounding**: lots → `SYMBOL_VOLUME_STEP`, giá → theo `_Point`.

## 6.5 On-Screen Dashboard (Real-time Monitor)

**Mục đích**: Hiển thị trạng thái EA real-time trên chart để dễ monitor khi test/trade.

**Nội dung Dashboard (Comment hoặc Label panel):**

```
┌─────────────────────────────────────────────┐
│ OAT_V4 - ICT/SMC + Momentum EA              │
├─────────────────────────────────────────────┤
│ STATE: ACTIVE_BASKET | SCAN | IDLE          │
│ Balance: $10,250.00 | MaxLot: 1.02          │
│ Floating P/L: +$45.50 (+0.44%)              │
├─────────────────────────────────────────────┤
│ SESSION FILTER: [✓] ON | [ ] OFF            │
│   Current: 15:30 (GMT+7)                    │
│   Status: [✓] IN SESSION (London)           │
│   Rollover: [ ] BLOCKED                     │
├─────────────────────────────────────────────┤
│ ACTIVE POI (Point of Interest):             │
│ ├─ FVG LONG:  2 active | 1 partial          │
│ │   #12: 2548.5-2550.2 (fill 35%)           │
│ │   #15: 2545.0-2547.5 (fill 62%) PARTIAL   │
│ ├─ FVG SHORT: 1 active                      │
│ │   #18: 2552.0-2554.5 (fill 10%)           │
│ ├─ OB LONG:   1 active                      │
│ │   #8: 2546.0-2548.0 (pb 45%, touch 1/2)   │
│ └─ MOMO:      1 LONG active (age 3 bars)    │
├─────────────────────────────────────────────┤
│ SIGNALS:                                    │
│ ├─ SMC:       [✓] VALID - FVG#15 fill 62%   │
│ └─ MOMENTUM:  [ ] NONE                      │
│ → RESOLVED:   SMC LONG (Momentum priority)  │
├─────────────────────────────────────────────┤
│ POSITIONS:                                  │
│ ├─ LONG:  2 orders | 0.15 lots | Avg 2547.5 │
│ │   #1: 0.10 @ 2548.0 | SL 2545.0 | +$12    │
│ │   #2: 0.05 @ 2546.0 | SL 2543.0 | +$8     │
│ └─ SHORT: 0 orders                          │
├─────────────────────────────────────────────┤
│ DCA STATUS:                                 │
│ ├─ Next Add: 800 pts from avg (need 1500)  │
│ ├─ Orders: 2/5 | Step: 1500 pts             │
│ └─ Lot Cap: 0.15/1.02 (14.7% used)          │
├─────────────────────────────────────────────┤
│ BASKET LIMITS:                              │
│ ├─ TP: +0.50% ($51.25) | Current: +0.44%    │
│ ├─ SL: -0.80% ($82.00) | Current: +0.44%    │
│ └─ Daily Limit: -1.20% | Today: -0.15%      │
├─────────────────────────────────────────────┤
│ TRAILING:                                   │
│ ├─ MOMO #1: [✓] ACTIVE (profit 1.2R)        │
│ │   ATR Trail: SL moved 350 pts             │
│ └─ SMC: Breakeven mode                      │
├─────────────────────────────────────────────┤
│ LAST ACTION:                                │
│ 15:28:45 - ORDER_PLACED: LONG 0.10 @ 2548.0 │
│ 15:29:12 - TRAILING_SL: Ticket 123456 moved │
│ 15:30:00 - SESSION_CHECK: In session ✓      │
└─────────────────────────────────────────────┘
```

**Update frequency**: Mỗi tick (hoặc mỗi giây để tránh lag).

**Vị trí**: Góc trái trên chart (có thể config).

**Format**:
- **Comment()**: Đơn giản, nhanh.
- **Label Objects**: Đẹp hơn, custom được font/color.

**Màu sắc**:
- ✅ Green: Active/Valid/Profit
- ❌ Red: Blocked/Invalid/Loss
- ⚠️ Yellow: Warning/Partial
- ⚪ Gray: Idle/Neutral

---

# 7) Bảng tham số (type, default, min/max, lý do)

> **Lưu ý**: **POINTS** trừ khi ghi rõ PIPS.

| Nhóm         | Tên tham số            | Type   |          Default |                           Min/Max | [Why]                       |
| ------------ | ---------------------- | ------ | ---------------: | --------------------------------: | --------------------------- |
| General      | Timezone               | string | Asia/Ho_Chi_Minh |                                 — | Đồng bộ phiên/nhật ký.      |
| General      | OneTradePerBar         | bool   |             true |                                 — | Anti-spam.                  |
| Entry.Common | BOS_FractalK           | int    |                2 |                               1–4 | Ổn swing.                   |
| Entry.Common | ATR_Period             | int    |               14 |                             10–20 | Chuẩn displacement/trail.   |
| SMC          | MinDispATR_SMC         | double |              1.0 |                           0.8–2.0 | Lọc phá yếu.                |
| SMC          | FVG_MinSizePts         | int    |              300 |                           150–600 | Tránh gap nhiễu.            |
| SMC          | OB_Pullback_MinPct     | %      |               25 |                             10–60 | Pullback “đã vào vùng”.     |
| SMC          | FVG_Fill_MinPct        | %      |               50 |                             25–80 | Fill đủ sâu.                |
| MOMO         | MinDispATR_Momo        | double |              1.2 |                           1.0–2.5 | Chống false break.          |
| SL/TP        | SLTP_DeriveFromMethod  | bool   |             true |                                 — | Giữ semantics phương pháp.  |
| SL/TP        | DistanceUnit           | enum   |           POINTS |                       PIPS/POINTS | Linh hoạt input.            |
| SL/TP        | PointsPerPip           | int    |               10 |                              5–20 | XAU mặc định 10.            |
| SL/TP        | SLTP_Override_Mode     | enum   |        Structure | Structure/RMultiple/FixedDistance | Khi `Derive=false`.         |
| SL/TP        | SL_FixedDist           | double |              500 |                          150–3000 | 50 pip = 500 pts.           |
| SL/TP        | TP_FixedDist           | double |             1000 |                          300–6000 | 100 pip = 1000 pts.         |
| SL/TP        | SLBufferPts            | int    |              300 |                           200–600 | Tránh quét sát vùng.        |
| SL/TP        | MinStopPointsClamp     | int    |              300 |                              ≥300 | Yêu cầu 30 pip.             |
| Trail        | TrailStepMinPts        | int    |              300 |                           200–600 | Giảm whipsaw.               |
| MOMO Trail   | ATR_Mult               | double |              2.0 |                           1.5–3.0 | Theo biến động.             |
| DCA          | EnableDCA              | bool   |             true |                                 — | Bật DCA.                    |
| DCA          | MaxOrders              | int    |                6 |                              2–10 | Kiểm soát DD.               |
| DCA          | StepPoints             | int    |             2000 |                         1000–3000 | Nhịp DCA.                   |
| DCA          | MinDistFromAvg         | int    |             1000 |                          500–3000 | Tránh add sát.              |
| DCA          | BaseRiskPct_PerAdd     | %Bal   |            0.10% |                        0.05–0.30% | Kiểm soát risk/add.         |
| DCA          | LotMultiplier          | double |             1.10 |                         1.00–1.20 | Tránh phình lot.            |
| DCA          | MaxLotPerSide          | lots   |             5.00 |                           ≥VolMin | Trần an toàn.               |
| DCA          | CapMode                | enum   |             SOFT |                         HARD/SOFT | SOFT giảm lots để vừa trần. |
| DCA          | OnMaxLotExceededAction | enum   |      ReduceToFit |                 BlockAdds/Flatten | Hành vi khi vượt trần.      |
| Basket       | BasketTP_PctBalance    | %Bal   |             0.3% |                          0.1–1.0% | Khoá lợi nhuận.             |
| Basket       | BasketSL_PctBalance    | %Bal   |             1.2% |                          0.5–3.0% | Bảo vệ tài khoản.           |
| Exec         | SlippageMaxPoints      | int    |              120 |                            50–200 | Chất lượng khớp.            |
| Exec         | RetryOnReject          | int    |                2 |                               0–3 | Độ bền đặt lệnh.            |
| Session      | EnableSessionFilter    | bool   |            false |                                 — | Bật lọc giờ trade (OFF).    |
| Session      | Session1_Start         | string |          "08:00" |                                 — | Session 1 start (GMT+7).    |
| Session      | Session1_End           | string |          "11:30" |                                 — | Session 1 end.              |
| Session      | Session2_Start         | string |          "14:00" |                                 — | Session 2 start.            |
| Session      | Session2_End           | string |          "17:00" |                                 — | Session 2 end.              |
| Session      | Session3_Start         | string |          "19:00" |                                 — | Session 3 start.            |
| Session      | Session3_End           | string |          "23:30" |                                 — | Session 3 end.              |
| Session      | RolloverFilterMins     | int    |                5 |                               0–15 | Chặn ±X phút quanh 00:00.   |

---

# 8) State machine (mô tả văn bản)

`IDLE → SCAN → RESOLVE → PENDING_ENTRY → ACTIVE_BASKET → (ADD_OK | PARTIAL | TRAILING | BASKET_TP | BASKET_SL | TIMEOUT) → EXITED`

* **IDLE**: chờ tick/điều kiện thời gian.
* **SCAN**: tính swings/ATR/BOS/OB/FVG/momentum signals.
* **RESOLVE**: xử lý xung đột SMC vs Momentum.
* **PENDING_ENTRY**: chờ bar close/confirm (nếu cấu hình).
* **ACTIVE_BASKET**: đã có lệnh; theo dõi DCA, partial, trailing, basket TP/SL, breach.
* **EXITED**: không còn vị thế; đi journal & quay lại IDLE.
* **BREACH (global)**: khi DailyLossLimit/breach khác → dừng vào lệnh đến hết ngày.

---

# 9) Pseudocode (triển khai module)

```pseudocode
// ==== UNIT HELPERS ====
ToPoints(v, unit, ppp=10):
    return (unit == PIPS) ? round(v * ppp) : round(v)

PriceFromPoints(entry, pts, dir, isSL):
    if dir == BUY:
        return entry - pts*_Point if isSL else entry + pts*_Point
    else:
        return entry + pts*_Point if isSL else entry - pts*_Point

// ==== SIGNALS ====
DetectSwings(fractal_k):
    // trả về danh sách SwingH/L chỉ số + giá
DetectBOS(fractal_k, atr_period, min_disp_atr):
    // nến Close phá Swing kèm TrueRange >= ATR*min_disp_atr
DetectOBFVG(...):
    // OB: last opposite candle trước impulse; FVG: gap 3-candle >= FVG_MinSizePts

BuildSignal_SMC():
    if !BOS.valid: return NONE
    zone = Pick(OB or FVG) if meets size rules
    trigger = PullbackToOB>=OB_Pullback_MinPct or FVG_Fill>=FVG_Fill_MinPct
    if trigger: return {dir, method:SMC, zone, bos_bar}

BuildSignal_MOMO():
    if Close crosses SwingH/L and TR >= ATR*MinDispATR_Momo:
        return {dir, method:MOMO, swing}

// ==== RESOLVE ====
ResolveSignals(s_smc, s_momo):
    if s_smc.nil and s_momo.nil: return NONE
    if both and same dir: return prioritize(MethodPriority)
    if both and opposite dir: apply ConflictPolicy (NoTrade/PreferTrend/PreferSMC/PreferMOMO)
    else return the existing one

// ==== SL/TP ====
ComputeSLTP(signal, entry_price):
    if SLTP_DeriveFromMethod:
        if signal.method == SMC:
            sl_pts = max( StructureStopPts(signal.zone) + SLBufferPts, MinStopPointsClamp )
            (tp1_pts, tp2_pts) = StructureTargetsPts(signal.zone) or (RtoPts(1), RtoPts(2))
        else: // MOMO
            sl_pts = max( SwingStopPts(signal.swing) + SLBufferPts, MinStopPointsClamp )
            (tp1_pts, tp2_pts) = (RtoPts(1), RtoPts(2))
    else:
        sl_pts = ToPoints(SL_FixedDist, DistanceUnit, PointsPerPip)
        tp1_pts = ToPoints(TP_FixedDist, DistanceUnit, PointsPerPip)
        tp2_pts = tp1_pts // or 2*tp1_pts if configured

    SL = PriceFromPoints(entry_price, sl_pts, signal.dir, isSL=true)
    TP1 = PriceFromPoints(entry_price, tp1_pts, signal.dir, isSL=false)
    TP2 = PriceFromPoints(entry_price, tp2_pts, signal.dir, isSL=false)
    return (SL, TP1, TP2, sl_pts)

// ==== LOTS & CAP ====
LotsByRiskPct(balance, risk_pct, stop_pts):
    money_risk = balance * risk_pct
    // value_per_point = TickValue per point (dev dùng SymbolInfoDouble calculations)
    lots = money_risk / (stop_pts * value_per_point)
    return RoundToVolumeStep(lots)

EnforceMaxLotPerSide(side, lots_new):
    if MaxLotPerSide <= 0: return lots_new
    lots_side = SumOpenLots(side)
    if lots_side + lots_new <= MaxLotPerSide: return lots_new

    if CapMode == HARD:
        return 0 if OnMaxLotExceededAction == BlockAdds else 0 // Flatten optional
    else: // SOFT
        allow = MaxLotPerSide - lots_side
        adj = RoundToVolumeStep(max(0, allow))
        return (adj >= SYMBOL_VOLUME_MIN) ? adj : 0

// ==== PLACE FIRST ORDER ====
PlaceFirstOrder(signal):
    entry = GetEntryPrice(signal) // market at close or limit at zone edge
    (SL, TP1, TP2, sl_pts) = ComputeSLTP(signal, entry)
    lots_raw = LotsByRiskPct(AccountBalance(), BaseRiskPct_PerAdd, sl_pts)
    lots = EnforceMaxLotPerSide(signal.dir, lots_raw)
    if lots <= 0: return FAIL("Lot cap")
    SendOrder(signal.dir, lots, entry, SL, TP1) // TP2 via separate order or virtual
    SetState(ACTIVE_BASKET)

// ==== DCA ADD ====
MaybeAddDCA(signal):
    if !EnableDCA or OrdersCount(signal.side) >= MaxOrders: return
    if DistanceToAvg(signal.side) < MinDistFromAvg: return
    if DistanceToLastAdd(signal.side) < StepPoints: return
    lots_raw = LotsByRiskPct(AccountBalance(), BaseRiskPct_PerAdd, sl_pts) * pow(LotMultiplier, AddIndex(signal.side))
    lots = EnforceMaxLotPerSide(signal.side, lots_raw)
    if lots > 0: SendAdd(signal.dir, lots)

// ==== BASKET MANAGER ====
ManageBasket():
    if BasketTP_PctBalance>0 and FloatingPLPct() >= BasketTP_PctBalance: CloseAllSide()
    if BasketSL_PctBalance>0 and FloatingPLPct() <= -BasketSL_PctBalance: CloseAllSide()
    if TimeoutMins>0 and ElapsedSinceEntry() >= TimeoutMins: CloseAllSide()

// ==== TRAILING ====
DoTrailing(signal):
    if signal.method == MOMO and Reached1R:
        ATRTrail(ATR_Period, ATR_Mult, TrailStepMinPts)
    if signal.method == SMC:
        StructureTrail(TrailStepMinPts)

// ==== MAIN LOOP ====
OnTick():
    if Breach(): return
    if OneTradePerBar and NewBar():
        s_smc = BuildSignal_SMC()
        s_momo = BuildSignal_MOMO()
        s = ResolveSignals(s_smc, s_momo)
        if s: PlaceFirstOrder(s)
    if InActiveBasket(): 
        MaybeAddDCA(s)
        DoTrailing(s)
        ManageBasket()
```

---

# 10) Ví dụ số (XAUUSD)

* **Ví dụ 1 – SMC Pullback (Buy)**
  Entry tại **2,550.00**; OB đáy **2,547.00** ⇒ dày OB = **300 points**; `SLBuffer=300`.
  → **StructureStop**: dưới mép OB **300 pts** nữa ⇒ **SL = 2,546.70** (Clamp ≥ 300 ok).
  Nếu `Derive=false`, `SL_FixedDist=50 pip` ⇒ **500 points** ⇒ **SL = 2,545.00**.

* **Ví dụ 2 – Momentum (Buy)**
  Close phá SwingH với range = **1.4×ATR(14)** (≥1.2 hợp lệ).
  `SL` sau Swing + **300 pts**; **TP1=1R** (partial 40%), **TP2=2R**; đạt 1R thì **ATR-trail** (14, 2.0, step 300).

* **Ví dụ 3 – DCA Cap mềm**
  `MaxLotPerSide=5.00`, đang có **3.40 lots (Buy)**. DCA đề xuất **2.00** ⇒ cho phép **1.60** (round theo step 0.01) → **1.60 lots**.

---

# 11) Backtest & Optimization Protocol

* **Data window**: 12–24 tháng gần nhất; XAUUSD **M5** (mặc định), so sánh **M15**.
* **WFO**: chia **70/30** theo quý; tối ưu phạm vi:

  * `MinDispATR_SMC ∈ [0.8..1.6]`, `MinDispATR_Momo ∈ [1.0..1.8]`,
  * `OB_Pullback_MinPct ∈ [15..45]`, `FVG_Fill_MinPct ∈ [35..65]`,
  * `StepPoints ∈ [1500..3000]`, `LotMultiplier ∈ [1.05..1.15]`, `MaxOrders ∈ [4..7]`.
* **Reject overfit** nếu PF trên train >> test (>30%), #trades/test < 200, hoặc DD test > 1.5× DD train.
* **KPI**: PF≥1.3 test, Winrate≥48% (momo) / ≥52% (smc), Expectancy>0, MaxDD ≤ 12%, #trades ≥ 200/6mo.

---

# 12) Test Cases & Edge Cases

* **Digits/Point khác thường**: kiểm tra `SymbolInfoDouble(_Point)`; `PointsPerPip` auto theo XAU = 10 (allow override).
* **MODE_STOPLEVEL** cao: nếu SL/TP < stop level → chuyển sang **virtual SL/TP** + **CloseOnTouch**.
* **Slippage spike**: vượt `SlippageMaxPoints` ⇒ retry 2 lần; nếu vẫn fail ⇒ **ABORT**.
* **Partial fills/Reject**: log đầy đủ, không nhân đôi lệnh.
* **Gaps**: open gap vượt SL/TP ⇒ dùng **Market close** với price hiện tại & **journaling**.
* **Timeout**: đóng toàn basket khi hết hạn.
* **Breach**: chạm **DailyLossLimit** ⇒ **disable entries** đến hết ngày ICT+7.

---

# 13) Definition of Done (DoD) & Handover Checklist

* [ ] Toàn bộ tham số trong bảng **có thể set** qua Input/Param.
* [ ] Đã chuẩn hoá **pip↔points**; **MinStop clamp** hoạt động.
* [ ] **SMC/Momentum** chạy độc lập hoặc hybrid; **ConflictPolicy** áp đúng.
* [ ] **TP/SL** gắn theo **phương pháp Entry**; **Override FixedDistance** hoạt động khi bật.
* [ ] **DCA** theo %Balance + Multiplier; **MaxLotPerSide** (HARD/SOFT) **đang enforce**.
* [ ] **Basket TP/SL** theo %Balance, **Timeout**, **Breach** hoạt động.
* [ ] **OneTradePerBar**, **RetryOnReject**, **SlippageMax** hoạt động.
* [ ] **Journal** đầy đủ (signals, prices, lots, slippage, reasons).
* [ ] Backtest pass KPI tối thiểu ở **test set**.

---
RULE 
---
Tuyệt vời — em bổ sung **quy tắc vòng đời (lifecycle)** cho từng cấu trúc: **FVG, OB, Momentum leg, Sideway BOX**, gồm: **khi hình thành**, **đang hiệu lực**, **hoàn thành/mitigated**, **hết hiệu lực/invalid**, **hết hạn/expired theo thời gian**, **renew (tạo mới & dọn cũ)**; kèm **quy tắc vẽ BOX & ghi nhãn**; **cửa sổ quét (bao nhiêu cây nến)**; và **cách cho phép nhiều cấu trúc đồng thời & chia nhỏ nhiều lệnh**. Tất cả đều “codeable”.

---

# 1) Decompose → Plan → ToT (scored) → Reverse Thinking

**Decompose**

* **Đối tượng & vòng đời**: FVG, OB, Momentum leg, Sideway BOX (mỗi đối tượng có trạng thái: `NEW → ACTIVE → (PARTIAL|MITIGATED) → (COMPLETED|INVALID|EXPIRED)`).
* **Quét & TTL**: số **bars** để quét & thời hạn (**TTL_Bars**) riêng cho từng đối tượng (M5 mặc định, M15 nhân đôi).
* **Entry Engine**: cho phép **nhiều đối tượng cùng chiều** phát sinh **nhiều entry** (split risk) có giới hạn **MaxOrders & MaxLotPerSide**.
* **Charting**: quy tắc vẽ **BOX** & **label** (màu, text, id, status, age, size).

**Plan (chuỗi xử lý)**

1. Mỗi bar mới: **Quét** cấu trúc (FVG/OB/BOS/Momentum) trong **Lookback_Bars**.
2. **Cập nhật vòng đời** từng đối tượng theo giá hiện tại (fill %, invalid…), đổi trạng thái & vẽ/ẩn box.
3. **Sinh tín hiệu entry** từ đối tượng **ACTIVE** theo rule; quản lý **split entries** (nhiều đối tượng).
4. **Cưỡng chế rủi ro**: MaxOrders/MaxLotPerSide/Basket SL.
5. **Dọn cũ & Renew** theo TTL, số lượng tối đa, BOS mới.

**ToT (3 kiểu quản trị đối tượng)**

* **Keep-Few-Smart (Recommended)**: giữ **K mới nhất mỗi chiều** + TTL; dọn cũ khi **BOS mới** (Correctness 9 | Risk 5 | Cost 6).
* **Keep-All-with-TTL**: giữ tất cả trong TTL (8 | 6 | 5).
* **One-At-A-Time**: mỗi chiều chỉ 1 đối tượng (7 | 4 | 7) — ít tín hiệu, bỏ lỡ cơ hội.

**Reverse Thinking**

* Giữ quá nhiều FVG/OB ⇒ **đè chồng tín hiệu**, dễ vượt `MaxOrders/MaxLotPerSide` ⇒ đặt **K nhỏ** (2–4/cùng chiều) và **Priority** (gần giá > xa; mới > cũ; size vừa > quá mỏng).

---

# 2) Lifecycle chi tiết theo phương pháp

> Mặc định **khung M5** (XAUUSD). Với **M15**, gợi ý nhân đôi TTL & Lookback.

## 2.1 FVG (3-candle Fair Value Gap)

### A. Khi **hình thành (NEW)**

* **Up-FVG** (dưới → trên): tại index `i` nếu `Low[i] > High[i-2]` và `size_pts = (Low[i] - High[i-2])/_Point ≥ FVG_MinSizePts` (mặc định **300 points**).
* **Down-FVG** tương tự: `High[i] < Low[i-2]`.
* Lưu trữ: `id`, `dir`, `upper/lower`, `size_pts`, `bar_index_created`, `status=NEW`.

### B. Khi **ACTIVE**

* Trở thành **ACTIVE** ngay sau **NEW** (hoặc có option delay X bars).
* **Hiệu lực entry** khi **fill% ≥ FVG_Entry_MinPct** (mặc định **50%**) hoặc đạt điều kiện riêng (ví dụ “**SMC Pullback** vào FVG”).

### C. **Mitigation / Completion**

* **Mitigated (PARTIAL)**: `fill% ≥ FVG_MitigatePct` (mặc định **50%**) nhưng **< FVG_CompletionPct** (mặc định **95%**).
* **Completed (COMPLETED)**: `fill% ≥ FVG_CompletionPct` **hoặc** có **1 nến Close** **vượt hẳn biên xa** của gap **≥ FVG_CloseBeyondPts** (mặc định **50 points**) → coi như **rebalance xong**.

### D. **Invalidation**

* Nến **đóng cửa** **vượt hẳn** biên xa **+ Buffer** (mặc định **SLBufferPts=300**) **và** **tiếp diễn thêm 1 nến** cùng phía (xác nhận) ⇒ trạng thái **INVALID** (phá cấu trúc).
* *Khác với “Completed”*: `COMPLETED` = **điền đủ** gap; `INVALID` = **bị phá** vượt xa (thường bỏ ý nghĩa entry pullback).

### E. **Hết hạn theo thời gian (EXPIRED)**

* Quá **FVG_TTL_Bars** (mặc định **150 bars** trên M5) **mà chưa Mitigated/Completed**, auto **EXPIRED** (giảm nhiễu).

### F. **Renew**

* Khi xuất hiện **BOS mới** cùng chiều → **tạo FVG mới**; áp `ZoneKeepPolicy`:

  * **K_FVG_KeepPerSide = 3** (mặc định): chỉ giữ 3 FVG mới nhất cùng chiều, cũ hơn → **ARCHIVED** (ẩn & không trade).
  * Nếu **FVG mới** “bao trùm” > **X%** FVG cũ (mặc định **80%**) → gộp & **deprecate** FVG cũ.

### G. **Quét bao nhiêu cây nến** - DYNAMIC SCAN

* **FVG quét động**: Giá tới đâu quét tới đó, **KHÔNG** giới hạn Lookback cứng.
* **Loại bỏ FVG đã hoàn thành** (COMPLETED/INVALID/EXPIRED) khỏi danh sách Active.
* **Max concurrent**: `K_FVG_KeepPerSide = 3` (giữ tối đa 3 FVG Active mỗi chiều). **CONFIRMED**.

### H. **Nhiều FVG & nhiều lệnh**

* Cho phép entry **tối đa N_FVG_ActiveEntries = 2** mỗi chiều; ưu tiên **FVG gần giá** & **size vừa**;
* **Split risk**: mỗi FVG tiêu thụ **≤ 1/N_FVG_ActiveEntries** của `MaxOrders` còn lại; vẫn **enforce MaxLotPerSide**.

---

## 2.2 OB (Order Block)

### A. Khi **hình thành (NEW)**

* Sau khi có **BOS** (close vượt swing), **OB** là **nến ngược chiều cuối** trước impulse tạo BOS.
* Vùng OB = [**High, Low**] của nến đó (tuỳ Buy/Sell); có thể **RefineBody** = [Open, Close] (config).

### B. Khi **ACTIVE**

* Hiệu lực cho **pullback**: entry hợp lệ khi giá **đi vào OB ≥ OB_Pullback_MinPct** (mặc định **25%** độ dày OB).

### C. **Mitigated / Multi-touch**

* **Mitigated (PARTIAL)**: khi **touch ≥ OB_MitigatePct** (mặc định **33%**).
* Cho phép **MaxTouches** (mặc định **2**): sau **touch #MaxTouches**, chuyển **COMPLETED** (coi như dùng xong), trừ khi có **rejection mạnh** (Close đảo chiều tạo **HL/LH mới**), khi đó phép **1 lần extra** (config).

### D. **Invalidation**

* **Close vượt biên đối diện OB + Buffer (SLBufferPts)** ⇒ **INVALID** (vùng mất ý nghĩa cung/cầu).
* Hoặc **CHOCH** ngược chiều (Close phá swing ngược) ngay **bên trong** vùng ⇒ **INVALID**.

### E. **Hết hạn (EXPIRED)**

* **OB_TTL_Bars = 200** (M5). Quá TTL mà **chưa pullback** ⇒ **EXPIRED**.

### F. **Renew**

* **BOS mới** cùng chiều ⇒ tạo **OB mới**; áp **K_OB_KeepPerSide=2**. OB cũ **xa giá** hơn **MaxDistanceFromPricePts** (mặc định **8000 points**) auto **ARCHIVED**.

---

## 2.3 Momentum leg (Breakout/Displacement)

### A. Khi **hình thành (NEW)**

* **BarBreakout** đóng **trên SwingH** (Buy) / **dưới SwingL** (Sell) **và** `TrueRange ≥ ATR(14) * MinDispATR_Momo` (mặc định **1.2**).
* Ghi nhận **pre-breakout range** = [Swing, Close trước], **bar_range_pts**, **dir**, **status=NEW**.

### B. Khi **ACTIVE**

* Entry kiểu **Momentum**: vào **ngay close** bar phá (market) hoặc **Stop** tại biên Swing ± buffer.
* Với **SMC**: có thể chờ **pullback** về OB/FVG sinh ra **bởi chính leg này**.

### C. **Kết thúc “leg” (COMPLETED)**

* Bất kỳ điều kiện nào sau đây (chọn 1 trong 3 → **COMPLETED**):

  1. **TP1 (1R)** đạt và **ATR-trail** đã kích hoạt ≥ X bars (mặc định **3 bars**).
  2. **Pullback test** về **mid của breakout bar** và **reject** tạo **HL/LH mới** cùng chiều.
  3. **Time-based**: quá **MOMO_TTL_Bars = 20** (M5).

### D. **Hết tác dụng (INVALID)**

* **False Break**: trong **MOMO_Fail_Bars = 5**, có **Close** **trở lại** **bên trong 50% pre-breakout range** **2 lần liên tiếp**.
* **CHOCH ngược chiều**: Close phá **swing đối diện** kể từ khi leg bắt đầu.
* **Close xuyên “đáy/đỉnh” breakout bar** **+ Buffer** trong **2 bars** liên tiếp.

### E. **Renew**

* Nếu xuất hiện **breakout mới** cùng chiều có `TR/ATR` **lớn hơn** leg hiện tại ≥ **1.1×**, mark leg cũ **COMPLETED** và rebase sang leg mới (đảm bảo “động lực” tươi).

---

## 2.4 Sideway BOX (để “kết thúc FVG” & quản trị vùng)

### A. Khi **hình thành (NEW)**

* **BOX** phát hiện khi trong **S_Window = 20 bars** (M5) có **biên độ** `MaxHigh - MinLow ≤ Box_MaxWidthPts` (mặc định **4000 points**) **và** **không** có nến `TrueRange ≥ ATR(14)*Box_BreakoutATR` (mặc định **1.2**).
* Mép BOX = `MaxHigh` & `MinLow` trong cửa sổ.

### B. Khi **ACTIVE**

* Vẽ **BOX** để *“neo”* các **FVG/OB** phía trong. Nếu **FVG được Completed** bên trong BOX, có thể **đánh dấu sub-box** “FVG done”.

### C. **Kết thúc (COMPLETED)**

* Khi có **nến đóng cửa** **vượt mép BOX + Box_BufferPts** (mặc định **150 points**) **và** `TrueRange ≥ ATR*Box_BreakoutATR` ⇒ **BOX COMPLETED** (breakout).
* **FVG end hook**: nếu BOX chứa FVG và FVG đạt **Completed**, vẽ **mini-box END** (đoạn fill cuối).

### D. **Invalid**

* **3 lần false break** (đóng ra–vào liên tiếp 3 lần) trong **Box_FalseBreakBars = 10** ⇒ BOX **INVALID** (nhiễu), sẽ **renew** nếu điều kiện lại thỏa.

### E. **Renew**

* Khi BOX kết thúc/invalid, bắt đầu đếm lại cửa sổ; có thể **nối** thành **BOX mới** nếu giá quay lại dao động hẹp.

---

# 3) Quy tắc **vẽ BOX & nhãn (text)**

## 3.1 Đối tượng & màu (suggest)

* **FVG**: Rectangle mờ. `ACTIVE` xanh lá (up) / đỏ (down); `PARTIAL` vàng; `COMPLETED` xám; `INVALID` đen gạch chéo; `EXPIRED` ẩn.
* **OB**: Rectangle viền dày; màu giống FVG theo chiều; `Mitigated` chấm bi; `Invalid` gạch chéo.
* **Momentum leg**: Arrow/line theo hướng; `COMPLETED` mảnh; `INVALID` đứt nét.
* **Sideway BOX**: Rectangle xanh dương nhạt; `COMPLETED` đổi sang tím trong 3 bars, rồi ẩn.

## 3.2 Nội dung label (mỗi BOX/zone)

```
<ID>#<dir> <type> <status>
age=<bars> size=<pts> fill=<%> touches=<n> TTL=<remain>
entry=<rule> stop=<rule> tp=<rule>   // nếu đối tượng sinh entry
```

* **ID** tăng dần; **dir**: UP/DN; **type**: FVG/OB/BOX/MOMO; **status** như lifecycle.

## 3.3 Quy tắc vẽ/ẩn

* Vẽ **khi NEW/ACTIVE/PARTIAL**;
* **COMPLETED**: giữ lại **Label** trong **KeepLabels_Bars=10** rồi ẩn;
* **INVALID/EXPIRED**: ẩn ngay hoặc mờ 30%.

---

# 4) Nhiều mô hình đồng thời & chia nhiều lệnh (split entries)

**Policy (khuyến nghị)**

* **Max concurrent objects per side**:

  * `K_FVG_KeepPerSide=3`, `K_OB_KeepPerSide=2`, `K_MOMO_Keep=1`, `K_BOX_Keep=1`.
* **Entry budget**: tổng số lệnh mới (chưa tính DCA) **≤ NewEntryBudget = min(2, MaxOrders - CurrentOrders)**.
* **Ưu tiên**: (1) **FVG gần giá** & **size vừa** (300–1200 pts) → (2) **OB gần giá** → (3) **Momentum stop**.
* **Split risk**: chia đều **BaseRiskPct_PerAdd** cho số đối tượng được chọn trong `NewEntryBudget`.
* **Tôn trọng**: `MaxLotPerSide`, `CapMode`, `MinDistFromAvg`.

---

# 5) Tham số mới (bổ sung cho lifecycle)

| Nhóm  | Tham số            | Default |   Min/Max | [Why]                            |
| ----- | ------------------ | ------: | --------: | -------------------------------- |
| FVG   | FVG_MinSizePts     |     300 |   150–600 | Gap đủ ý nghĩa.                  |
| FVG   | FVG_Entry_MinPct   |     50% |    25–80% | Pullback đủ sâu.                 |
| FVG   | FVG_MitigatePct    |     50% |    33–80% | Gắn trạng thái PARTIAL.          |
| FVG   | FVG_CompletionPct  |     95% |   80–100% | Hoàn tất rebalance.              |
| FVG   | FVG_CloseBeyondPts |      50 |    20–100 | Close vượt biên xa coi như xong. |
| FVG   | FVG_TTL_Bars       |     150 |    60–300 | Hết hạn theo thời gian.          |
| FVG   | FVG_Lookback_Bars  |     600 |  300–1200 | Cửa sổ quét.                     |
| FVG   | K_FVG_KeepPerSide  |       3 |       1–5 | Giới hạn số FVG hoạt động.       |
| OB    | OB_Pullback_MinPct |     25% |    10–60% | Điều kiện entry.                 |
| OB    | OB_MitigatePct     |     33% |    25–60% | Đánh dấu PARTIAL.                |
| OB    | OB_TTL_Bars        |     200 |    80–400 | Hết hạn theo thời gian.          |
| OB    | MaxTouches         |       2 |       1–3 | Số lần “dùng” vùng.              |
| MOMO  | MinDispATR_Momo    |     1.2 |   1.0–2.5 | Chống false break.               |
| MOMO  | MOMO_Fail_Bars     |       5 |       2–8 | Kiểm định thất bại sớm.          |
| MOMO  | MOMO_TTL_Bars      |      20 |     10–40 | Leg quá cũ thì xong.             |
| BOX   | S_Window           |      20 |     10–40 | Cửa sổ sideway.                  |
| BOX   | Box_MaxWidthPts    |    4000 | 2000–8000 | Độ hẹp sideway.                  |
| BOX   | Box_BreakoutATR    |     1.2 |   1.0–2.0 | Xác nhận breakout.               |
| BOX   | Box_BufferPts      |     150 |    50–300 | Tránh false break.               |
| BOX   | Box_FalseBreakBars |      10 |      5–20 | Nhiễu → invalid.                 |
| Chart | KeepLabels_Bars    |      10 |      0–50 | Giữ dấu vết.                     |

---

# 6) Pseudocode (quản trị lifecycle & entry đa đối tượng)

```pseudocode
OnNewBar():
  UpdateATR()
  DetectSwings(fractal_k)
  new_fvg = DetectFVG(FVG_Lookback_Bars, FVG_MinSizePts)
  new_ob  = DetectOB_OnBOS()
  new_momo = DetectMomentumBreakout(MinDispATR_Momo)

  RegisterObjects(new_fvg, new_ob, new_momo)  // push to store with id, dir, status=NEW

  For each obj in Store:
    UpdateLifecycle(obj)   // -> ACTIVE/PART
```
Dưới đây là bản “write-up” kỹ thuật hoá toàn bộ TP/SL/Entry cho ICT–SMC–Momentum, bổ sung chính xác theo tài liệu bạn đưa, đặc biệt trả lời các điểm bạn yêu cầu: khi nào mô hình hình thành, khi nào hết tác dụng/hoàn thành, khi nào “renew”, vẽ BOX & gán nhãn, quét bao nhiêu nến, có thể có nhiều FVG và chia nhiều lệnh.

---

# 1) Decompose → Plan → ToT (scored) → Reverse Thinking

**Decompose (7 khối):**

1. Entry Logic (ICT/SMC): Sweep → Displacement (MSS/BOS) → POI (FVG/OB) → Premium/Discount.   
2. Market Filters: Spread guard, Session/Kill Zone, Premium/Discount.  
3. Momentum Module: Displacement = nến có range > ATR*N; exit kiểu Chandelier/ATR trail.  
4. POI Lifecycle: FVG/OB formation → active → mitigated/invalidated → renew & archive.  
5. Order Sizing & DCA: nhiều POI, chia lệnh, MaxLotPerSide.
6. Risk/Exit: SL chuẩn cấu trúc (đáy/đỉnh sweep), TP mục tiêu “điểm yếu” hoặc thanh khoản (BSL/SSL), RR cố định optional; momentum dùng ATR trail/đảo tín hiệu.   
7. Visualization & State Machine: BOX + text, TTL & scan windows, states từ Scan→Signal→Pending→Active→Exit.

**Plan (chuỗi xử lý mỗi bar):**
(1) Cập nhật swing, BOS/MSS, displacement (ATR), Premium/Discount → (2) Phát hiện POI mới (FVG/OB), đăng ký BOX & TTL → (3) Bộ lọc session/spread → (4) Lập danh sách Entry candidates (prioritize) → (5) Đặt limit/market theo rule → (6) Quản trị vị thế (SL/TP/Trail/Partial) → (7) Đổi trạng thái POI (mitigated/invalidated/expired), vẽ “End Box”.

**ToT – 3 phương án quản trị FVG lifecycle (điểm chính bạn hỏi):**

* **A) TTL theo thời gian (bars)**: FVG/OB hết hiệu lực sau `ttl_bars` nếu chưa được “touch/mitigate”.

  * *Score*: Correctness 7/10, Risk 6/10, Cost/Time 3/10 (dễ code).
* **B) TTL theo cấu trúc**: POI sống đến khi có BOS ngược + displacement phá vỡ phạm vi tạo ra POI.

  * *Score*: Correctness 9/10, Risk 5/10, Cost/Time 6/10 (logic chặt, code phức tạp hơn).
* **C) TTL lai (time + structure) + khối lượng (nếu có)**: hết hạn nếu quá `ttl_bars` **hoặc** xuất hiện BOS ngược có displacement **hoặc** ATR regime chuyển thấp kéo dài.

  * *Score*: Correctness 9/10, Risk 4/10, Cost/Time 7/10.
    **Khuyến nghị:** C (lai), vì bám sát “displacement/structure” và tránh giữ POI cũ kỹ.

**Reverse Thinking (contrarian):**

* Nếu “displacement” chỉ là nến lớn vì news/spread spike? → Bắt buộc xác nhận FVG xuất hiện đồng thời và spread guard + news embargo. 
* Nếu FVG bị “lấp” bằng **wick** mỏng → Cho phép trạng thái “partially mitigated” và vẫn còn hiệu lực nếu chưa 100% filled.
* Nếu nhiều FVG xếp tầng gây overtrading → Hạn chế `max_pending_pois`, ưu tiên theo “độ tươi” + “kích thước FVG/ATR” + Premium/Discount. 

---

# 2) Questions cần để chốt (targeted)

1. **Symbol/TF & Broker**: vẫn XAUUSD M5? digits 3/5? min lot step? stopLevel? (để tính SL/TP theo points chính xác).
2. **Session TZ**: giữ Asia/Ho_Chi_Minh → quy đổi Kill Zone sang broker time hay UTC? 
3. **News filter**: có bật/nguồn nào?
4. **MaxLotPerSide**: giá trị mặc định & tăng theo DCA hay cứng tổng?
5. **TP/SL override**: Khi bật “TP/SL theo pip”, có **ghi đè** toàn bộ rule cấu trúc (ICT/SMC) hay chỉ là “TP2” song song?
6. **Khối lượng**: Chia lệnh theo bao nhiêu POI tối đa cùng lúc (`max_pois_active`), và có cho phép stacking trên 1 POI (edge/mid/50%)?

---

# 3) SPEC chi tiết (SRS/PRD + Pseudocode)

## 3.1. Glossary (định nghĩa có thể code)

* **Swing High/Low**: nến có high cao hơn/lower thấp hơn N nến hai bên (`swing_lookback_period`, mặc định 2). 
* **Displacement**: nến C có **range** > ATR(N)*M; khuyến nghị N=14, M=2.0. 
* **Liquidity Sweep**: price quét qua mức thanh khoản bằng wick nhưng **đóng** trở lại bên trong. Điều kiện: `low<L && close>L` (với đáy), ngược lại cho đỉnh. 
* **FVG (3 nến)**: Bullish: `c3.low > c1.high`; Bearish: `c3.high < c1.low`; nến 2 lý tưởng là displacement. 
* **Order Block (OB)**: nến ngược xu hướng cuối cùng **trước** displacement gây BOS/CHoCH; ưu tiên OB đã quét thanh khoản và tạo FVG.  
* **Premium/Discount**: phạm vi chia bởi 50% fib: trên = Premium (bán), dưới = Discount (mua). 
* **Điểm Mạnh/Yếu**: swing tạo BOS ⇒ “mạnh”; swing không tạo high/low tiếp theo ⇒ “yếu” (mục tiêu TP). 
* **Kill Zones**: London Open, NY Open… thuật toán chỉ hoạt động trong các cửa sổ này. 

## 3.2. Lifecycle & BOX (hình thành/kết thúc/renew)

### FVG Lifecycle

* **Formation**: khi phát hiện pattern 3 nến thỏa điều kiện; lưu `fvg_id`, `type`, biên `upper/lower`, `formed_bar_index`, `atr_at_birth`. 
* **Active (Valid)** nếu:

  * Kích thước ≥ `fvg_min_size_atr_mult * ATR` tại thời điểm hình thành. (mặc định 0.5). 
  * Thuộc vùng đúng (Bullish FVG nằm trong Discount; Bearish trong Premium) – optional filter. 
* **Completed (Mitigated 100%)**: khi **giá chạm & đi xuyên toàn bộ vùng** (close hoặc wick chạm cạnh đối diện) → đổi trạng thái `mitigated=true`, vẽ BOX “FVG Mitigated – #id – time”.
* **Partially Mitigated**: giá “touch” nhưng chưa lấp 100% → vẫn **Valid** cho đến khi đủ 100% hoặc hết TTL.
* **Invalidated** (hết tác dụng):

  * BOS ngược chiều **có displacement** phá vỡ **đáy/đỉnh** tạo ra FVG. (structure-based TTL). 
  * Hoặc quá `ttl_bars` kể từ `formed_bar_index` mà chưa được test (time-based TTL).
  * Hoặc ATR regime tụt < ngưỡng (`atr_regime_min`) quá `regime_ttl_bars`.
* **Renew**: bất cứ khi nào xuất hiện displacement mới tạo FVG mới ⇒ tạo **BOX mới**; **không** gộp FVG cũ–mới, nhưng có thể **stack** theo thứ tự ưu tiên (xem 3.4).

**Vẽ BOX & Text (FVG):**

* Rect màu theo type; Label: `FVG-[B|S] #[id] size=XX pts ATR=YY formed=t` + `state=[Active|Partial|Mitigated|Invalid]` + `TTL=[x/y]`.
* Khi “Completed/Invalidated” → vẽ **End Box** mờ (dấu hiệu kết thúc) + note “reason=[Mitigated/BOS-Inv/Time-Exp]”.

### OB Lifecycle

* **Formation**: nến ngược xu hướng cuối cùng trước displacement gây BOS/CHoCH; lưu vùng [low,high]. 
* **Active** nếu: đăng ký đúng hướng + (tuỳ chọn) **đã quét thanh khoản trước đó** + có FVG cùng pha. 
* **Mitigated**: giá quay về **chạm** OB (edge hoặc 50%) và rời đi; nếu lấp >50% vẫn consider “live” cho lệnh limit tại edge còn lại (tuỳ chọn).
* **Invalidated**: giá **đóng** vượt hẳn qua vùng OB + BOS ngược chiều có displacement; hoặc quá `ttl_bars`.
* **Renew**: khi có displacement mới kèm BOS → tạo OB mới, ưu tiên OB “thứ 2” theo khuyến nghị SMC. 

**Vẽ BOX & Text (OB):**

* Label: `OB-[B|S] #[id] width=XX pts FVGlink=[id?] swept=[Y/N] state=...`.

### Liquidity (BSL/SSL, EQH/EQL, PDH/PDL, PWH/PWL)

* Lập bản đồ các mức thanh khoản: PDH/PDL, PWH/PWL, Đỉnh/Đáy phiên Á, EQL/EQH (có `tolerance`). 
* “Quét thanh khoản” định nghĩa như trên; dùng để **kích hoạt** mô hình đảo chiều. 

## 3.3. Entry Rules (ICT/SMC core)

**Chuỗi chuẩn (Long):**

1. **Sweep đáy** (SSL taken) theo định nghĩa wick/close. 
2. **MSS/BOS tăng** với **displacement** (nến > ATR*M). 
3. **POI**: chọn **FVG/OB** hình thành trong displacement ở (2), **nằm trong Discount**.  
4. **Kill Zone/Session** hợp lệ → đặt **limit** tại mép gần nhất của POI. 
5. **SL** = **dưới đáy** của cú sweep (điểm vô hiệu cấu trúc). **TP** = **đỉnh yếu/BSL** kế tiếp hoặc thêm RR cố định (2R–3R).  

**Chuỗi Short**: đối xứng (sweep đỉnh → MSS giảm → Bearish POI ở Premium → limit tại cạnh gần → SL trên đỉnh sweep → TP về đáy yếu/SSL).

## 3.4. Ưu tiên & nhiều POI (nhiều FVG/OB, chia lệnh)

* `poi_priority` (giảm dần):

  1. **Tuổi trẻ** (mới hình thành)
  2. **Kích thước** FVG lớn theo ATR (≥ `fvg_min_size_atr_mult`) 
  3. **Confluence**: POI trong đúng Premium/Discount, có **sweep trước đó**, có **FVG+OB** chung pha.  
* `max_pending_pois_per_side` (ví dụ 3) + `max_positions_per_side`.
* **Chia lệnh** trên **1 POI**: `EntryDistributionMode = EDGE_ONLY | EDGE+MID | EDGE+MID+50%` (tỉ lệ 50/30/20).
* **Chia lệnh** trên **nhiều POI**: dàn theo priority cho tới khi chạm `MaxLotPerSide`.

## 3.5. Momentum Systems (tách module)

* **MA Crossover**: vào khi đóng nến giao cắt; **Exit** bằng **ATR trailing (Chandelier)** hoặc **đảo tín hiệu**; TP cố định là optional.  
* **Breakout + Volume** (nếu có volume): xác nhận phá vỡ kèm spike volume. 

**Khi momentum “hết”:**

* ATR giảm dưới `atr_exhaustion_mult * ATR_baseline` nhiều bar liên tiếp **hoặc** xuất hiện giao cắt đảo chiều (MA) → đóng lệnh. 

## 3.6. TP/SL (chuẩn & override)

* **ICT/SMC chuẩn**:

  * **SL**: đáy/đỉnh của **sweep** (điểm invalid). 
  * **TP1**: **điểm yếu** gần nhất (EQH/EQL, swing yếu), TP2: BSL/SSL tiếp theo **hoặc** 2R–3R. 
  * **Trailing** (tuỳ chọn): Chandelier ATR. 
* **Momentum**: **không** đặt TP cố định mặc định, chạy theo **ATR trail** hoặc **đảo tín hiệu**. 
* **Override “TP/SL theo pip”** (yêu cầu bạn):

  * `use_fixed_pips_sl_tp=true` → SL/TP = `sl_pips`/`tp_pips` tính **POINTS** (chuẩn hoá theo symbol digits).
  * Khi bật override: hệ **SMC** vẫn vẽ/đánh dấu mục tiêu cấu trúc nhưng **không ép** dùng làm TP/SL.

## 3.7. Market Filters

* **Premium/Discount** phải khớp hướng (on by default). 
* **Kill Zone/Session** (London/NY) chỉ kích hoạt trong cửa sổ giờ. 
* **Spread guard**: `max_spread_points` (vd XAUUSD M5 ~350 points mặc định domain).
* **News embargo**: tắt đặt lệnh X phút quanh tin (nếu bạn bật).

## 3.8. Order/Risk Manager

* **MaxLotPerSide**: trần tổng **khối lượng mở + pending** mỗi chiều.
* **Position limits**: `max_positions_per_side`, `max_pending_pois_per_side`.
* **One-trade-per-bar** (optional), **retry on requote**.
* **Rủi ro** theo %balance (Elliott doc khuyên 1–3%/trade, RR ≥ 3:1 – tham khảo để set default). 

## 3.9. Visualization (vẽ BOX & Text)

* **FVG Box**: màu theo direction; viền nét đứt nếu Partial. Text: `FVG-B#[id] size=.. ATR=.. state=.. TTL k/n`.
* **OB Box**: màu khác; Text: `OB-B#[id] swept=Y/N hasFVG=Y/N state=..`.
* **Liquidity Lines**: PDH/PDL, PWH/PWL, EQH/EQL (ghi `tol=X pts`). 
* **End Box** (khi hoàn thành/invalid): hộp mờ + ghi reason.

## 3.10. State Machine (text)

* **SCAN**: cập nhật swing/BOS/ATR; detect FVG/OB/liquidity; cập nhật TTL.
* **SIGNAL_READY**: hội đủ sweep + MSS + POI + filters.
* **PENDING**: đặt limit; huỷ nếu POI invalid/expired hoặc spread/news vi phạm.
* **ACTIVE**: quản trị SL/TP/trail/partials.
* **EXITED**: ghi nhật ký; update POI state (Mitigated/Invalid).
* **CLEANUP**: vẽ End Box, lưu metrics.

## 3.11. Pseudocode (rút gọn – đủ cho dev)

```pseudo
on_bar_close():
  updateATR()
  swings = detectSwings(N=swing_lookback_period)                 // :contentReference[oaicite:55]{index=55}
  structure = updateStructure(swings, structure_break_type)       // BOS/MSS
  if isDisplacement(current_bar, ATR_period, ATR_mult):           // :contentReference[oaicite:56]{index=56}
      newFVGs = detectFVGs(current_index)                          // :contentReference[oaicite:57]{index=57}
      newOBs  = detectOBs(structure)                               // :contentReference[oaicite:58]{index=58}
      registerPOIs(newFVGs, newOBs)

  updateLiquidityMap(PDH/PDL, PWH/PWL, SessionHigh/Low, EQH/EQL)   // :contentReference[oaicite:59]{index=59}
  updatePOILifecycle(TTL, structure, ATR_regime)

  if sessionFilterOK() and spreadOK() and newsOK():
     for side in [LONG, SHORT]:
        sweepOK = detectLiquiditySweep(side)                       // :contentReference[oaicite:60]{index=60}
        mssOK   = structure.hasMSSWithDisplacement(side)
        poiList = getPOIs(side, inPremiumDiscountRange=true)       // :contentReference[oaicite:61]{index=61}
        if sweepOK and mssOK and not exceedLimits(side):
            sortedPOIs = prioritize(poiList)                       // sizeATR, age, confluence
            for poi in sortedPOIs:
               placeLimitAtEdge(poi)
               if exceedMaxPending(): break

on_tick():
  manageOrdersAndPositions():
    for pos in openPositions:
       if use_fixed_pips_sl_tp:
           enforceFixedSLTP(pos)
       else:
           enforceStructuralSL(pos)                                // SL = low/high of sweep :contentReference[oaicite:62]{index=62}
           setTPtoWeakHighLowOrRR(pos)                             // :contentReference[oaicite:63]{index=63}
           if momentum_mode: applyATRTrailing(pos)                 // :contentReference[oaicite:64]{index=64}
       if exitSignal(pos): close(pos)
  updateBoxesAndLabels()
```

## 3.12. Parameters (mẫu chính)

| Tên                           | Kiểu            |      Default |  Min/Max | [Why/Impact]                    |
| ----------------------------- | --------------- | -----------: | -------: | ------------------------------- |
| `swing_lookback_period`       | int             |            2 |      1–5 | Nhận diện fractal/swing.        |
| `structure_break_type`        | enum{Wick,Body} |         Body |        – | Nghiêm ngặt phá vỡ bằng close.  |
| `displacement_atr_period`     | int             |           14 |     5–50 | Độ nhạy biến động.              |
| `displacement_atr_multiplier` | float           |          2.0 |      1–4 | Nến đủ “mạnh”.                  |
| `fvg_min_size_atr_mult`       | float           |          0.5 |    0.1–2 | Lọc FVG nhỏ.                    |
| `poi_ttl_bars`                | int             |           48 |    5–500 | TTL theo thời gian.             |
| `atr_regime_min_ratio`        | float           |          0.6 |    0.3–1 | TTL theo regime.                |
| `max_pending_pois_per_side`   | int             |            3 |     1–10 | Tránh overtrading.              |
| `max_positions_per_side`      | int             |            3 |     1–10 | Giới hạn phơi nhiễm.            |
| `MaxLotPerSide`               | lot             | **bạn chọn** |        – | Trần tổng khối lượng mỗi chiều. |
| `use_fixed_pips_sl_tp`        | bool            |        false |        – | Bật TP/SL theo pip (points).    |
| `sl_pips/tp_pips`             | float           | 500/1500 pts | 50–10000 | Override cấu trúc.              |
| `session_windows`             | json            |    London/NY |        – | Kill Zones.                     |
| `premium_discount_filter`     | bool            |         true |        – | Lọc vùng đúng hướng.            |
| `spread_max_points`           | int             |          400 |  50–2000 | Guard XAUUSD M5 (~350).         |

## 3.13. Backtest Protocol (tóm tắt)

* Data: 2–3 năm, M5 XAUUSD.
* WFO 70/30 theo quý, reject overfit khi PF chênh > 30% giữa IS/OOS.
* Tối ưu: `ATR_mult`, `fvg_min_size_atr_mult`, `poi_ttl_bars`, `session_windows`.

## 3.14. Test Cases & Edge Cases

* Spread spike > `spread_max_points` → **không** đặt lệnh.
* Gap mở cửa: POI bị xuyên → mark Invalidated & vẽ End Box.
* Chạm POI trong **phiên cấm** → giữ PENDING nhưng **không khớp** (flag).
* FVG chạm 30% → Partial; chạm 100% → Mitigated; BOS ngược displacement → Invalid.
* Nhiều FVG: chỉ giữ top-N theo priority; “drop oldest” khi vượt `max_pending_pois_per_side`.

---

# 4) Ví dụ nhỏ & sanity check

* **Displacement**: ATR(14)=200 pts; `ATR_mult=2.0` ⇒ nến phải có range > 400 pts để coi là displacement. 
* **FVG min size**: `fvg_min_size_atr_mult=0.5` ⇒ cần ≥100 pts (nếu ATR=200). 
* **TP theo cấu trúc**: sau Long, TP nhắm **đỉnh yếu** gần nhất (mục tiêu thanh khoản) thay vì số cố định → nhất quán với SMC. 

---

## Devil’s Advocate (rủi ro & hoá giải)

* **Tín hiệu giả trong range news/rollover** → bật session/news filter, yêu cầu displacement + FVG đồng thời. 
* **“Quá nhiều” POI** → ưu tiên & giới hạn N, `MaxLotPerSide` cắt đỉnh phơi nhiễm.
* **Override fixed pips** có thể trái cấu trúc → cảnh báo khi RR<1.5 và gợi ý TP cấu trúc làm TP2.

---

# Kết

Tài liệu trên đã bổ sung đúng trọng tâm bạn hỏi: điều kiện **hình thành–kết thúc–renew** cho **FVG/OB**, logic **vẽ BOX & Text**, **quy tắc quét nến/TTL**, **nhiều FVG/nhiều lệnh**, cùng **TP/SL** theo ICT/SMC/Momentum (và chế độ **TP/SL theo pip** có thể config). Các định nghĩa/công thức đều đã “codeable” và bám sát nguồn bạn cung cấp (FVG 3-candle, displacement=ATR-multiple, OB phải dẫn đến BOS kèm FVG, Premium/Discount filter, Kill Zones, mục tiêu “điểm yếu”/BSL/SSL).      

---

## Self-Review & Confidence

* **Logic check**: đã chuyển ngôn ngữ ICT/SMC → điều kiện đo-đếm (ATR, nến, points, TTL).
* **Edge cases**: spread spike, gaps, đa POI, partial mitigation đã có.
* **Confidence: High**, vì đặc tả bám sát tài liệu bạn đưa (đã trích dẫn), chỉ thêm lớp TTL/priority để dev triển khai ổn định.

---

## Cần bạn xác nhận (để mình chốt bản cuối & handover cho dev):

1. `MaxLotPerSide` (con số mặc định) và `max_pending_pois_per_side`.
2. Dùng **TP/SL theo pip** là **override** hoàn toàn hay chỉ là **TP2/SL2** song song?
3. Giờ **Kill Zones** theo broker time hay UTC?
4. Cho phép **stack entries** trên **1 POI** (EDGE/MID/50%) chứ?
   Xác nhận xong, mình đóng gói thêm **bảng tham số đầy đủ**, **flow chi tiết**, và **test checklist**.
